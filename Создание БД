CREATE DATABASE AutomobileFactory;

-- Пользователи
CREATE TABLE Users (
    ID_users SERIAL PRIMARY KEY,
    Login VARCHAR(30) UNIQUE NOT NULL,
    Password VARCHAR(50) NOT NULL
);

-- Роли
CREATE TABLE Roles (
    ID_role SERIAL PRIMARY KEY,
    Name VARCHAR(30) NOT NULL
);

-- Сотрудники
CREATE TABLE Employees (
    ID_employees SERIAL PRIMARY KEY,
    ID_users INT UNIQUE NULL,
    FOREIGN KEY (ID_users) REFERENCES Users(ID_users) ON DELETE CASCADE ON UPDATE CASCADE,
    Name VARCHAR(30) NOT NULL,
    Surname VARCHAR(30) NOT NULL,
    Birthday DATE NOT NULL,
    Series_and_number_passport TEXT NOT NULL,
    Phone_number VARCHAR(16) NOT NULL,
    Registration_date DATE NOT NULL DEFAULT CURRENT_DATE
);

-- Роли-Сотрудники
CREATE TABLE Role_Employees (
    ID_role INT NOT NULL,
    ID_employees INT NOT NULL,
    PRIMARY KEY (ID_role, ID_employees),
    FOREIGN KEY (ID_role) REFERENCES Roles(ID_role) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ID_employees) REFERENCES Employees(ID_employees) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Магазины
CREATE TABLE Stores (
    ID_store SERIAL PRIMARY KEY,
    Name VARCHAR(50) NOT NULL,
    Address VARCHAR(100) NOT NULL,
    Phone_number VARCHAR(16) NOT NULL
);

-- Поставка
CREATE TABLE Supplies (
    ID_supply SERIAL PRIMARY KEY,
    Date DATE NOT NULL,
    ID_store INT NOT NULL,
    FOREIGN KEY (ID_store) REFERENCES Stores(ID_store) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Марки
CREATE TABLE Brands (
    ID_brand SERIAL PRIMARY KEY,
    Name VARCHAR(50) NOT NULL,
    Country VARCHAR(30) NOT NULL
);

-- Модели
CREATE TABLE Models (
    ID_model SERIAL PRIMARY KEY,
    Name VARCHAR(30) NOT NULL,
    YEARS INT NOT NULL,
    BodyType VARCHAR(20) NOT NULL,
    Description TEXT NOT NULL,
    ID_brand INT NOT NULL,
    FOREIGN KEY (ID_brand) REFERENCES Brands(ID_brand) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Автомобили
CREATE TABLE Cars (
    ID_car SERIAL PRIMARY KEY,
    VIN VARCHAR(17) UNIQUE NOT NULL,
    ProductionYear INT NOT NULL,
    Color VARCHAR(20) NOT NULL,
    Status VARCHAR(20) NOT NULL CHECK (Status IN ('На продаже','В эксплуатации', 'В ремонте','Продан')),
    ID_model INT NOT NULL,
    FOREIGN KEY (ID_model) REFERENCES Models(ID_model) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Сборка
CREATE TABLE Assemblies (
    ID_assembling SERIAL PRIMARY KEY,
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP,
    ID_car INT NOT NULL,
    FOREIGN KEY (ID_car) REFERENCES Cars(ID_car) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT check_dates CHECK (start_date < end_date)
);

-- Сборка-Поставка
CREATE TABLE Supply_Assemblies (
    ID_assembling INT NOT NULL,
    ID_supply INT NOT NULL,
    PRIMARY KEY (ID_assembling, ID_supply),
    FOREIGN KEY (ID_assembling) REFERENCES Assemblies(ID_assembling) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ID_supply) REFERENCES Supplies(ID_supply) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Сборка-Сотрудники
CREATE TABLE Employees_Assemblies (
    ID_assembling INT NOT NULL,
    ID_employees INT NOT NULL,
    PRIMARY KEY (ID_assembling, ID_employees),
    FOREIGN KEY (ID_assembling) REFERENCES Assemblies(ID_assembling) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ID_employees) REFERENCES Employees(ID_employees) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Предложения
CREATE TABLE Proposals (
    ID_proposal SERIAL PRIMARY KEY,
    Name VARCHAR(50) NOT NULL,
    Price DECIMAL(10,2) NOT NULL,
    Description TEXT NOT NULL
);

-- Предложения_сборка
CREATE TABLE Proposal_Assemblies (
    ID_proposal INT NOT NULL,
    ID_assembling INT NOT NULL,
    PRIMARY KEY (ID_proposal, ID_assembling),
    FOREIGN KEY (ID_proposal) REFERENCES Proposals(ID_proposal) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ID_assembling) REFERENCES Assemblies(ID_assembling) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Оборудование
CREATE TABLE Equipments (
    ID_equipment SERIAL PRIMARY KEY,
    Name VARCHAR(50) NOT NULL,
    Type VARCHAR(30) NOT NULL,
    Manufacturer VARCHAR(50) NOT NULL,
    Purchase_date DATE NOT NULL,
    Status VARCHAR(20) NOT NULL CHECK (Status IN ('В эксплуатации','На ремонте', 'Выведен из эксплуатации','Планируется к замене','В обслуживании'))
);

-- Материалы
CREATE TABLE Materials (
    ID_material SERIAL PRIMARY KEY,
    Name VARCHAR(50) NOT NULL,
    Type VARCHAR(30) NOT NULL,
    Quantity INT NOT NULL,
    Unit VARCHAR(10) NOT NULL,
    Purchase_date DATE NOT NULL
);

-- Линии сборки
CREATE TABLE AssemblyLines (
    ID_assemblyLine SERIAL PRIMARY KEY,
    start_date TIMESTAMP NOT NULL DEFAULT CURRENT_DATE,
    ID_material INT NOT NULL,
    ID_equipment INT NOT NULL,
    FOREIGN KEY (ID_material) REFERENCES Materials(ID_material) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ID_equipment) REFERENCES Equipments(ID_equipment) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT check_dates_assemblyLines CHECK (start_date >= CURRENT_DATE)
);

-- Склады
CREATE TABLE Warehouses (
    ID_warehouse SERIAL PRIMARY KEY,
    Address TEXT NOT NULL,
    Phone_number VARCHAR(16) NOT NULL
);

-- Детали
CREATE TABLE Details (
    ID_detail SERIAL PRIMARY KEY,
    Name VARCHAR(50) NOT NULL,
    PartNumber VARCHAR(30) UNIQUE NOT NULL,
    Description TEXT NOT NULL,
    ID_warehouse INT NOT NULL,
    ID_assemblyLine INT NOT NULL,
    FOREIGN KEY (ID_warehouse) REFERENCES Warehouses(ID_warehouse) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ID_assemblyLine) REFERENCES AssemblyLines(ID_assemblyLine) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Склады-Автомобили
CREATE TABLE Car_Warehouses (
    ID_car INT NOT NULL,
    ID_warehouse INT NOT NULL,
    PRIMARY KEY (ID_car, ID_warehouse),
    FOREIGN KEY (ID_car) REFERENCES Cars(ID_car) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ID_warehouse) REFERENCES Warehouses(ID_warehouse) ON DELETE CASCADE ON UPDATE CASCADE,
    Date_delivery TIMESTAMP NOT NULL DEFAULT CURRENT_DATE,
	CONSTRAINT check_dates_car_warehouses CHECK (Date_delivery >= CURRENT_DATE)
);

-- Детали-Автомобили
CREATE TABLE Car_Details (
    ID_car INT NOT NULL,
    ID_detail INT NOT NULL,
    PRIMARY KEY (ID_car, ID_detail),
    FOREIGN KEY (ID_car) REFERENCES Cars(ID_car) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ID_detail) REFERENCES Details(ID_detail) ON DELETE CASCADE ON UPDATE CASCADE,
    Quantity INT NOT NULL
);

-- Детали-Материалы
CREATE TABLE Detail_Materials(
    ID_detail INT NOT NULL,
    ID_material INT NOT NULL,
    PRIMARY KEY (ID_detail, ID_material),
    FOREIGN KEY (ID_detail) REFERENCES Details(ID_detail) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ID_material) REFERENCES Materials(ID_material) ON DELETE CASCADE ON UPDATE CASCADE,
    Percentage_ratio DECIMAL(4,2) NOT NULL
);

